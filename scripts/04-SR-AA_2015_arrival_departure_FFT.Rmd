---
title: "AA_2015_arrival_departure_FFT"
output: html_document
date: "2025-06-19"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r AA airports}
df_aa_airports <- read.csv("pairs80.csv")
aa_airports <- df_aa_airports$origin[which(df_aa_airports$airline  == "AA")]
print(aa_airports)

```


```{r data 2015}
library(arrow)
library(tidyverse)
library(dplyr)

flight_df <- read_parquet("Year=2015/data_0.parquet")
# waves




flight_hubs_spokes <- flight_df |>
  dplyr::filter(Reporting_Airline == "AA" & (Origin == aa_airports | Dest == aa_airports)) |>
  mutate(weekday = wday(FlightDate, label = TRUE, week_start = 1),
         weekday = ifelse(weekday %in% c("Mon", "Tue", "Wed", "Thu", "Fri"), "weekday", "weekend"),
         DepTime = as_datetime(paste0("2015-01-01", "-", DepTime, "-00")),
         ArrTime = as_datetime(paste0("2015-01-01", "-", ArrTime, "-00"))) |>
  select(Reporting_Airline, FlightDate, DepTime, ArrTime, Origin, Dest) |>
  rename(dep_time = DepTime, arr_time = ArrTime,
         dep_airport = Origin, arr_airport = Dest) |>
  pivot_longer(cols = -c(FlightDate, Reporting_Airline),
               names_to = c("type", ".value"), names_sep = "_") |>
  dplyr::filter(airport %in% aa_airports) |>
  arrange(time)

flight_hubs_spokes |>
  dplyr::filter(!is.na(time)) |>
  ggplot(aes(time, color = type, fill = type)) +
  geom_density(alpha = 0.4) +
  #geom_histogram(bins = 23 * 6) +
  scale_x_datetime(date_labels =  "%H:%M", date_breaks = "2 hour") +
  facet_wrap(vars(airport), scales = "free_y", ncol = 2) +
  theme_minimal() +
  theme(strip.text = element_blank())

assign_time_blocks <- function(time_vector, block_size = 10) {
  start_time <- min(time_vector)
  block_start <- start_time + floor(as.numeric(difftime(time_vector, start_time, units = "mins")) / block_size) * block_size * 60
  return(block_start)
}

flight_hubs_spokes |>
  dplyr::filter(!is.na(time)) |>
  mutate(block = assign_time_blocks(time)) |>
  count(airport, type, block) |>
  mutate(n = ifelse(type == "dep", n, -n)) |>
  ggplot(aes(x = block, y = n, color = type, fill = type)) +
  geom_col() +
  scale_x_datetime(date_labels =  "%H:%M", date_breaks = "2 hour") +
  facet_wrap(vars(airport), scales = "free", ncol = 5) +
  theme_minimal()
```

## Spline fitting


```{r spline 2015, echo=FALSE}
library(splines)

# Collapse to daily time using fake date and bin
binned_data <- flight_hubs_spokes |>
  dplyr::filter(!is.na(time)) |>
  mutate(hour_minute = format(time, "%H:%M"),
         time_numeric = as.numeric(difftime(time, as.POSIXct("2024-01-01 00:00:00"), units = "mins"))) |>
  group_by(airport, type, time_numeric) |>
  summarise(n = n(), .groups = "drop")

# Fit a smooth spline for each airport and type
library(purrr)

# splines_df <- binned_data |>
#   group_by(airport, type) |>
#   group_modify(~{
#     fit <- smooth.spline(.x$time_numeric, .x$n, spar = 0.5)
#     tibble(time_numeric = fit$x, fitted = fit$y)
#   })

splines_df <- binned_data |>
  group_by(airport, type) |>
  group_modify(~{
    fit <- smooth.spline(.x$time_numeric, .x$n, spar = 0.5)
    tibble(
      time_numeric = fit$x,
      fitted = fit$y,
      airport = unique(.x$airport),
      type = unique(.x$type)
    )
  }) |>
  ungroup()


# Convert time_numeric back to POSIXct for plotting
splines_df <- splines_df |>
  mutate(time = as.POSIXct("2015-01-01", tz = "UTC") + time_numeric * 60)

binned_data <- binned_data |>
  mutate(time = as.POSIXct("2015-01-01", tz = "UTC") + time_numeric * 60)

# Plot
ggplot() +
  geom_line(data = binned_data, aes(x = time, y = n, color = type), alpha = 0.3) +
  geom_line(data = splines_df, aes(x = time, y = fitted, color = type), linewidth = 1.2) +
  facet_wrap(vars(airport), scales = "free_y", ncol = 5) +
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hour") +
  labs(title = "Smoothed Flight Activity (Spline Fit)",
       x = "Time of Day", y = "Flight Count") +
  theme_minimal()

```
## FFT for checking periodicity

```{r FFT 2015, echo = FALSE}

fft_all <- splines_df |>
  group_by(airport, type) |>
  group_modify(~{
    signal <- .x$fitted
    n <- length(signal)
    
    fft_result <- fft(signal)
    modulus <- Mod(fft_result)[1:(n/2)]
    freqs <- (0:(n/2 - 1)) / n
    periods_in_minutes <- 1 / freqs

    tibble(
      period_mins = periods_in_minutes,
      amplitude = modulus
    ) |>
      dplyr::filter(is.finite(period_mins), period_mins <= 1440) |>  # up to 24 hours
      mutate(airport = unique(.x$airport), type = unique(.x$type))
  }) |>
  ungroup()


# # Add hub group label
# fft_all <- fft_all |>
#   mutate(hub_group = ifelse(airport %in% aa_airports, "hub", "non-hub"))

# Plot with hubs and non-hubs in separate columns
ggplot(fft_all, aes(x = period_mins, y = amplitude, color = type)) +
  geom_line(linewidth = 1) +
  scale_x_continuous(
    trans = "log10",
    breaks = c(30, 60, 120, 180, 240, 360, 720, 1440),
    labels = function(x) paste0(x, " min")
  ) +
  facet_grid(rows = vars(airport), scales = "free_y", switch = "y") +
  labs(
    title = "FFT Periodicity of Flight Schedules",
    x = "Period (minutes, log scale)",
    y = "FFT Amplitude",
    color = "Type"
  ) +
  theme_minimal() +
  theme(
    strip.placement = "outside",
    strip.text.y.left = element_text(angle = 0))

```




```{r top 2 amplitudes}
top2_fft <- fft_all |>
  group_by(airport, type) |>
  slice_max(order_by = amplitude, n = 2, with_ties = FALSE) |>
  arrange(airport, type, desc(amplitude)) |>
  mutate(rank = row_number()) |>
  pivot_wider(names_from = rank, values_from = c(amplitude, period_mins),
              names_glue = "top{rank}_{.value}") |>
  ungroup()



top2_arr <- top2_fft |> filter(type == "arr")

p_arr <- ggplot(top2_arr, aes(x = top1_period_mins, y = top2_period_mins, label = airport)) +
  geom_point(color = "blue", size = 3) +
  geom_text(vjust = -0.6, size = 3.5) +
  scale_x_log10() +
  scale_y_log10() +
  labs(
    title = "Top 2 FFT Periods for Arrivals - AA (2015)",
    x = "Top 1 Period (min)",
    y = "Top 2 Period (min)"
  ) +
  theme_minimal()
ggsave("figures/top2_fft_arrivals.png", p_arr, width = 8, height = 6, dpi = 300, bg = "white")


top2_dep <- top2_fft |> filter(type == "dep")

p_dep <- ggplot(top2_dep, aes(x = top1_period_mins, y = top2_period_mins, label = airport)) +
  geom_point(color = "red", size = 3) +
  geom_text(vjust = -0.6, size = 3.5) +
  scale_x_log10() +
  scale_y_log10() +
  labs(
    title = "Top 2 FFT Periods for Departures",
    x = "Top 1 Period (min)",
    y = "Top 2 Period (min)"
  ) +
  theme_minimal()
ggsave("figures/top2_fft_departures.png", p_dep, width = 8, height = 6, dpi = 300, bg = "white")
```
## Clustering 
```{r clustering}
library(cluster)
library(dplyr)
library(ggplot2)



# Select and log-transform periods for clustering
arr_features <- top2_arr |> 
  mutate(log_p1 = log10(top1_period_mins),
         log_p2 = log10(top2_period_mins)) |> 
  select(airport, log_p1, log_p2)

dep_features <- top2_dep |> 
  mutate(log_p1 = log10(top1_period_mins),
         log_p2 = log10(top2_period_mins)) |> 
  select(airport, log_p1, log_p2)



# Arrival clustering
set.seed(123)
k_arr <- kmeans(arr_features[, -1], centers = 4)
arr_features$cluster <- factor(k_arr$cluster)

# Departure clustering
set.seed(123)
k_dep <- kmeans(dep_features[, -1], centers = 4)
dep_features$cluster <- factor(k_dep$cluster)

arr_cluster <- ggplot(arr_features, aes(x = log_p1, y = log_p2, label = airport, color = cluster)) +
  geom_point(size = 3) +
  geom_text(vjust = -0.6, size = 3.5) +
  labs(title = "Clustering of Airports by Top FFT Periods (Arrivals)",
       x = "log10(Top 1 Period)", y = "log10(Top 2 Period)") +
  theme_minimal()

 dep_cluster <-ggplot(dep_features, aes(x = log_p1, y = log_p2, label = airport, color = cluster)) +
  geom_point(size = 3) +
  geom_text(vjust = -0.6, size = 3.5) +
  labs(title = "Clustering of Airports by Top FFT Periods (Departures)",
       x = "log10(Top 1 Period)", y = "log10(Top 2 Period)") +
  theme_minimal()

arr_cluster; dep_cluster


```
