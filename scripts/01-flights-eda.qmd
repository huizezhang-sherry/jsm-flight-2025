---
title: "Exploratory data analysis on the marathon data"
date: "2025-03-06"
execute:
  warning: false
format: html
---


```{r setup, echo = FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
```

# Read in and clean data

```{r}
years <- c("2015", "2017", "2018", "2019", "2023", "2024")
files <- paste0("boston", years, ".csv")
raw <- map(files, ~here::here("data-raw", .x) |> map(read_csv)) |> bind_rows()

# god bless there is no same acronym for US and CA states
us_state <- c("DC", state.abb) 
ca_state <- c("AB", "BC", "MB", "NB", "NL", "NS", "NT", "NU", "ON", "PE", "QC", "SK", "YT")

boston <- raw |> 
  mutate(location = ifelse(str_detect(location, "\\?"), NA, location)) |>
  separate(location, sep = ", ", into = c("city", "state")) |> 
  mutate(
    state = str_to_upper(state),
    # clena up 	(select Country) in loc when state info is there but city info is not
    city = ifelse(str_detect(city, "Country"), NA, city),
    state = ifelse(state == "D.C.", "DC", state),
    # TODO there are more clearning needed here
    #state = ifelse(!state %in% c(us_state, ca_state), NA, state),
    country = ifelse(state %in% us_state, "domestic", "international"),
    year = as.factor(year(race_date))
    )
```

# Domestic vs. International

The proportion of international participants are increasing, but for the years we have (2015, 2017, 2018, 2019, 2023, 2024) roughtly 70% vs. 30% (20,000 vs. 5,000) domestic vs. international participants

Across all years:

```{r}
boston |> count(country) |> mutate(prop = n/ sum(n))
```

For each individual year:

```{r}
dom_int_df <- boston |>
  group_by(year, country) |> 
  summarise(n = n(), .groups = "drop") |> 
  pivot_wider(names_from = country, values_from = n) |> 
  mutate(dom_prop = domestic/(domestic + international))

dom_int_df |> 
  ggplot(aes(x = year, y = dom_prop, group = 1)) + 
  geom_point() + 
  geom_label(aes(y = dom_prop + 0.05, label = round(dom_prop, 3))) + 
  geom_line() + 
  ylim(0, 1) + 
  ylab("Proportion of domestic participants") 
```

About 500-1000 participants from ON and QC, Canada, each year, need to check if we have flights to/from Canada and whether this number will make an impact

```{r}
boston |> filter(state %in% ca_state) |> count(year, state) |> filter(n > 300)
```



# Among US states

The number of participants from each states doesn't seem to be changing much over the years. Here is a summary of the states: 

| Category | States (# of participants in 2024)| 
| ----------------------- | ------| 
| Staes that are too close to Boston and likely to have a humoungus confounding from other means of transportation and international flight | MA (3907) <br> NY (1321) <br> NJ (508) |
| States are likely to use flight as the primary commute - but we need to see whether the participants would make a difference on the flight | CA (1640) <br> TX (844) <br> FL (559) <br> CO (496) <br> WA (415) <br> UT (326) |
| Other state that are likley to commute by flight, but I suspect the count would be too low to make an impact|  OR(217) <br> AZ (186) |
| States I'm not sure | IL (598) <br> PA (573) <br> OH (516)|

```{r eval = FALSE}
dom_boston <- boston |> filter(country == "domestic")
state_count_df <- dom_boston |> count(year, state, sort = TRUE) 

# state_count_df |> 
#   ggplot(aes(x = year, y = n, group = state)) + 
#   geom_line() + 
#   coord_trans(y = "sqrt")

usa_map <- st_as_sf(maps::map("state", fill=TRUE, plot =FALSE)) |> 
  mutate(ID = str_to_title(ID)) |> 
  left_join(tibble(ID = state.name, state = state.abb), by = "ID") |>
  left_join(state_count_df)

ggplot(usa_map) +
  geom_sf(aes(fill = n), color = "#2b2b2b", size=0.125) +
  coord_sf(crs = st_crs("+proj=laea +lat_0=45 +lon_0=-100 +x_0=0 +y_0=0 +a=6370997 +b=6370997 +units=m +no_defs"), datum = NA) +
  ggthemes::theme_map()
```


This doesn't look good, for states that are far away from Boston, only about/ less than 100 people from each city/state participate in the marathon - we might not be able to see an effect on changes of flight behavior:

```{r}
boston2024 <- boston |> filter(year == "2024")
map_dfr(c("CA", "TX", "FL", "CO", "WA", "UT"), 
  ~boston2024 |> 
    filter(state == .x) |> 
    count(city, state, sort = TRUE) |> 
    group_by(state) |> head(2))

```

